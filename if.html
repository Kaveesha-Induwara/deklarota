<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

	<title>iframe</title>
	<style type="text/css" media="screen">
		body{margin:0;padding:0;overflow:hidden;-apple-dashboard-region: dashboard-region(control rectangle 0 0 0 0);}
	</style>
	<script type="text/javascript" charset="utf-8">
		function log(){
			opera.postError.apply(opera, arguments)
		}
	</script>
	<script type="text/javascript" charset="utf-8">
	get_script = function(script_path, callback){
		var _script = document.createElement('script');
			_script.setAttribute('type', 'text/javascript');
			if (callback) {_script.onload = callback};
			_script.setAttribute('src', script_path);
		document.documentElement.firstChild.appendChild(_script);
	}
	
	var scripts_loading_callback = function(current_script, scripts_number,callback){
		if ((current_script > 0) && (current_script == scripts_number) ) {
			if (callback && (typeof callback === 'function')){
				callback()
			}
			return true
			
		} 
		else {return false}
	}
	init_vk_p = function(volume, source){
		vk_p_in_iframe = new vk_p($(player_holder_node), volume);
		vk_p_in_iframe.player_source_window = source;
		source.postMessage("vk_p_inited",'*')
		log('/js/seesu.player.vk_p.js/js/seesu.player.vk_p.js/js/seesu.player.vk_p.js')
		window.removeEventListener("message", init_vk_p_listener, false);
	}
	init_vk_p_listener = function(e){
		if (e.origin.indexOf('widget://') == -1) {
			return
		} else {
			if (e.data.match(/init_vk_p/)){
				var params_from_source = e.data.split(',');
				var volume = params_from_source[1];
				init_vk_p_as_callback = (function(volume, source){
					//making closure of init_vk_p for cycle using 
					return function(){init_vk_p(volume, source);}
				})(volume, e.source);
				var scripts = params_from_source.slice(2);
				for (var i=0, l = scripts.length ; i < l; i++) {
					get_script(scripts[i], (function(current_script, scripts_number,callback){
						return function(){scripts_loading_callback(current_script, scripts_number,callback)}
					})(i+1, l, init_vk_p_as_callback))
				};
			}
		}
	}
	window.addEventListener("message", init_vk_p_listener, false);
	document.addEventListener("DOMContentLoaded", function(){
		player_holder_node = document.getElementById('player-holder');
	},false)
	</script>

</head>

<body>
<div id="player-holder"></div>
</body>
</html>
