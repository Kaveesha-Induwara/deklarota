<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

	<title>iframe</title>
	<script type="text/javascript" charset="utf-8" src="js/nice_alert.js"></script>
	<style type="text/css" media="screen">
		body{margin:0;padding:0;overflow:hidden;-apple-dashboard-region: dashboard-region(control rectangle 0 0 0 0);}
	</style>
	<script type="text/javascript" charset="utf-8">
	if  (navigator.userAgent.match(/Opera/)){
		log = function(){
			opera.postError.apply(opera, arguments)
		}
	} else {
		log = alert
	}
	</script>
	<script type="text/javascript">
	
	if (typeof console != 'object'){
		console = {};
		console.log = function(text){
			log(text)
		}	
	}
	</script>
	<script type="text/javascript" charset="utf-8">
	get_script = function(script_path, callback){
		var _script = document.createElement('script');
			_script.setAttribute('type', 'text/javascript');
			if (callback) {_script.onload = callback;};
			_script.setAttribute('src', script_path);
		document.documentElement.firstChild.appendChild(_script);
	}
	
	var scripts_loading_callback = function(current_script, scripts_number,callback){
		if ((current_script > 0) && (current_script == scripts_number) ) {
			if (callback && (typeof callback === 'function')){
				callback()
			}
			return true
			
		} 
		else {return false}
	}
	init_sm2_p = function(volume, source){
		sm2_p_in_iframe = new sm2_p(false, volume, soundManager);
		sm2_p_in_iframe.player_source_window = source;
		
		soundManager.onready(function() {
			
			if (soundManager.supported()) {
				
				//source.postMessage("sm2_p_inited",'*');
				log('sm2 iframe work');
				
			} else{
				log('by some reason sm2 iframe don"t work')
			}
		})
		
		window.removeEventListener("message", init_sm2_p_listener, false);
	}
	init_sm2_p_listener = function(e){
		if (e.data.match(/init_sm2_p/)){
			e.source.postMessage("sm2_p_inited",'*');
			var params_from_source = e.data.split(',');
			var volume = params_from_source[1];
			init_sm2_p_as_callback = (function(volume, source){
				//making closure of init_sm2_p for cycle using 
				return function(){init_sm2_p(volume, source);}
			})(volume, e.source);
			var scripts = params_from_source.slice(2);
			
			for (var i=0, l = scripts.length ; i < l; i++) {
				var _origin = e.origin;
				
				if (!_origin.match(/widget/) && !(location.protocol.match(/file/)) ){
					var script = scripts[i];
					var js_pos = script.indexOf('/js/');
					scripts[i] = 'http://seesu.heroku.com' + scripts[i].slice(js_pos);
				} else{
				}
				get_script(scripts[i], (function(current_script, scripts_number,callback){
					return function(){scripts_loading_callback(current_script, scripts_number,callback)}
				})(i+1, l, init_sm2_p_as_callback))
			};
		}
		
	}
	window.addEventListener("message", init_sm2_p_listener, false);
	</script>

</head>

<body>
<div id="player-holder"></div>
</body>
</html>
